#!/bin/bash
# 22.02.2015 - faster than drush sqlq
# 23.03.2015 - replace {table} to table with prefix
# v0.2

SCRIPT_HELP="
Execute sql query.
Same as drush sql-query, but faster.

Usage: {0} \"query\"

Table names must be encapsulated in {} if db has prefixes, ex.
AELECT COUNT(*) FROM {node}"

. drupal-scripts-init

check_drupal

if [ $# = 0 ]; then
	usage
	exit 1
fi

function s(){
	drupal-database-settings "$1"
}

function sql(){
	prefix=$(s prefix)
	sql=$(echo $1 | sed "s/{\(.*\?\)}/${prefix}\1/g")
	[ -n "$SCRIPT_VERBOSE" ] && echo >&2 "sql: $sql"

	[ -n "$SCRIPT_VERBOSE" ] && echo >&2 "connect: -u$(s username) -p$(s password) -h$(s host) -P$(s port) $(s database)"

	mysql -Brs -u"$(s username)" -p"$(s password)" -h"$(s host)" -P"$(s port)" "$(s database)" <<< "$sql"
}

function sqlq(){
	sql "$1" 2>/dev/null
}

if [ -n "$SCRIPT_VERBOSE" ]; then
	sql "$1"
else
	sqlq "$1"
	if [ $? -ne 0 ]; then
		echo "error"
		exit 1
	fi
fi